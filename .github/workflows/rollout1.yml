name: Rollout 1

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v1    
    - name: 'Whitelisting Row A users'
      uses: zenithworks/rollout@master
      with:
        action-type: 'SET_CONDITION'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A'"       
    
    - name: 'Turn-on the feature flag'
      uses: zenithworks/rollout@master
      with:
        action-type: 'TURN_ON'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'       

    - name: 'Rollout to 10% of users'
      uses: zenithworks/rollout@master
      with:
        action-type: 'SET_CONDITION'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A' \n- target: 'userId'\n  op: '%'\n  value: '10'"
    - name: Perform Health Checks
      run: |
        echo Reaching out to health enpoints...
        sleep 1
        echo Running health checks...
        sleep 4
        echo Health checks complete
    - name: 'Rollout to segment RowB users'
      uses: zenithworks/rollout@master
      with:
        action-type: 'SET_CONDITION'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A' \n- target: 'userId'\n  op: '%'\n  value: '10' \n- target: 'row'\n  op: '='\n  value: 'B'"
    - name: Perform Health Checks
      uses: jakejarvis/wait-action@master
      with:
        time: '180s' 
    - name: 'Rollout to 50% of users'
      uses: zenithworks/rollout@master
      with:
        action-type: 'SET_CONDITION'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A' \n- target: 'userId'\n  op: '%'\n  value: '50' \n- target: 'row'\n  op: '='\n  value: 'B'"
    - name: Perform Health Checks
      uses: jakejarvis/wait-action@master
      with:
        time: '180s' 
    - name: 'Rollout to 100% of users'
      uses: zenithworks/rollout@master
      with:
        action-type: 'SET_CONDITION'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A' \n- target: 'userId'\n  op: '%'\n  value: '100' \n- target: 'row'\n  op: '='\n  value: 'B'"
