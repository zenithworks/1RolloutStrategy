name: Percentage based rollout

on: [push]
#env:
#  FEATURE_FLAG: 'Microsoft.FeatureFlagDemo.GreenBackground'  
jobs:   
  build:    
    runs-on: ubuntu-latest    
    steps:
    - uses: actions/checkout@v1    
      
    - name: 'WHITELIST QA USERS'
      uses: zenithworks/rollout@master
      with:
        action-type: 'set_condition'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'  
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A'"       
    
    - name: 'TURN ON THE FEATURE FLAG'
      uses: zenithworks/rollout@master
      with:
        action-type: 'TURN_ON'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'       
    
    - name: WAIT FOR QA FEEDBACK
      run: |
        echo Waiting for QA feedback...        
        sleep 5
        echo Proceeding with roll out...
        
    - name: 'ROLL OUT TO 10% USERS'
      uses: zenithworks/rollout@master
      with:
        action-type: 'set_condition'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A' \n- target: 'userId'\n  op: '%'\n  value: '10'"

    - name: 'PERFORM HEALTH CHECKS'
      run: |
        echo Reaching out to health end points...        
        sleep 4
        echo Health checks complete - SUCCESS
        
    - name: 'ROLL OUT TO SEGMENT  B USERS'
      uses: zenithworks/rollout@master
      with:
        action-type: 'set_condition'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A' \n- target: 'userId'\n  op: '%'\n  value: '10' \n- target: 'row'\n  op: '='\n  value: 'B'"
    
    - name: 'PERFORM HEALTH CHECKS'
      run: |
        echo Reaching out to health end points...        
        sleep 4
        echo Health checks complete - SUCCESS
    
    - name: 'ROLLOUT TO 50% OF USERS'
      uses: zenithworks/rollout@master
      with:
        action-type: 'set_condition'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A' \n- target: 'userId'\n  op: '%'\n  value: '50' \n- target: 'row'\n  op: '='\n  value: 'B'"
    
    - name: 'PERFORM HEALTH CHECKS'
      run: |
        echo Reaching out to health end points...        
        sleep 4
        echo Health checks complete - SUCCESS
    
    - name: 'ROLLOUT TO 100% USERS'
      uses: zenithworks/rollout@master
      with:
        action-type: 'set_condition'
        project-id: '008af12b-94a6-4015-8633-4f50cc02b9c0'
        feature-flag-name: 'Microsoft.FeatureFlagDemo.GreenBackground'
        feature-flag-condition: "- target: 'row'\n  op: '='\n  value: 'A' \n- target: 'userId'\n  op: '%'\n  value: '100' \n- target: 'row'\n  op: '='\n  value: 'B'"
